# CI/CD Health Dashboard Deployment Guide

This directory contains Terraform configuration and deployment scripts for the CI/CD Health Dashboard on AWS infrastructure.

## Architecture Overview

The infrastructure includes:

- **VPC**: 10.10.0.0/16 with 4 subnets (2 public, 2 private)
- **Public Subnets**: 10.10.1.0/27, 10.10.2.0/27 (32 IPs each)
- **Private Subnets**: 10.10.3.0/27, 10.10.4.0/27 (32 IPs each)
- **EC2 Instances**: 
  - 1 Public instance (Frontend + Backend + Jenkins)
  - 1 Private instance (MongoDB Database)
- **Security Groups**: Properly configured for secure communication

## Prerequisites

1. **AWS CLI** configured with appropriate credentials
2. **Terraform** (>= 1.0)
3. **SSH Key Pair** (automatically generated by deploy script)

## Deployment Workflow

The deployment process is now split into multiple stages for better control and troubleshooting:

### Stage 1: Deploy Infrastructure Only

```bash
# Make scripts executable
chmod +x deploy-infra-only.sh

# Deploy only the AWS infrastructure
./deploy-infra-only.sh
```

This script will:
- Generate SSH key pair
- Initialize Terraform
- Plan and apply infrastructure
- Output connection information
- **Note**: No application code is deployed at this stage

### Stage 2: Copy Application Code

```bash
# Make scripts executable
chmod +x copy-app-code.sh

# Copy application code to EC2 instances
./copy-app-code.sh
```

This script will:
- Extract application code to public EC2 instance
- Set up Docker containers (Frontend, Backend, Jenkins, Nginx, Redis)
- Extract application code to private EC2 instance
- Set up MongoDB and Mongo Express containers
- Start all services

### Stage 3: Jenkins Setup

```bash
# Make scripts executable
chmod +x jenkins-setup.sh

# Configure Jenkins
./jenkins-setup.sh
```

This script will:
- Wait for Jenkins to be ready
- Display the initial admin password
- Provide setup instructions
- Help configure Jenkins API token

## Quick Start (All Stages)

If you want to run all stages in sequence:

```bash
# Make all scripts executable
chmod +x deploy-infra-only.sh copy-app-code.sh jenkins-setup.sh

# Stage 1: Deploy infrastructure
./deploy-infra-only.sh

# Stage 2: Deploy application code
./copy-app-code.sh

# Stage 3: Setup Jenkins
./jenkins-setup.sh
```

## Access the Application

After deployment, you'll get:

- **Frontend URL**: http://[PUBLIC-IP]:3000
- **Backend API**: http://[PUBLIC-IP]:5001
- **Jenkins**: http://[PUBLIC-IP]:8080
- **MongoDB**: Accessible from public EC2 instance only
- **Mongo Express**: http://[PRIVATE-IP]:8081 (via SSH tunnel)

## Configuration

### Key Files

- `main.tf` - Main infrastructure configuration
- `variables.tf` - Variable definitions
- `outputs.tf` - Output values
- `terraform.tfvars` - Variable values
- `user_data_public_compact.sh` - Public EC2 setup script
- `user_data_private_compact.sh` - Private EC2 setup script

### Important Variables

```hcl
aws_region = "us-west-2"
instance_type = "t3.medium"
database_instance_type = "t2.micro"
vpc_cidr = "10.10.0.0/16"
jenkins_url = "http://[PUBLIC-IP]:8080"
jenkins_username = "admin"
jenkins_api_token = "your-api-token"
```

## SSH Access

### Public EC2 Instance

```bash
ssh -i ~/.ssh/cicd-dashboard-key ec2-user@[PUBLIC-IP]
```

### Private EC2 Instance (via public instance)

```bash
ssh -i ~/.ssh/cicd-dashboard-key -J ec2-user@[PUBLIC-IP] ec2-user@[PRIVATE-IP]
```

## Application Services

### Public EC2 Instance

- **Frontend**: Node.js/Express on port 3000
- **Backend**: Python/Flask on port 5001
- **Jenkins**: CI/CD server on port 8080
- **Nginx**: Reverse proxy on ports 80/443
- **Redis**: Caching on port 6379

### Private EC2 Instance

- **MongoDB**: Database on port 27017
- **Mongo Express**: Web UI on port 8081

## Jenkins Configuration

### Initial Setup

1. **Access Jenkins**: Go to `http://[PUBLIC-IP]:8080`
2. **Initial Password**: Use the password shown by `jenkins-setup.sh`
3. **Install Plugins**: Choose "Install suggested plugins"
4. **Create Admin User**: Set up your admin account

### API Token Setup

1. **Create API Token**: 
   - Go to Manage Jenkins > Manage Users > admin > Configure
   - Click "Add new Token"
   - Name: `cicd-dashboard-token`
   - Copy the generated token

2. **Update Configuration**:
   ```bash
   # Update terraform.tfvars with the new API token
   jenkins_api_token = "your-new-api-token"
   
   # Restart the backend service
   ssh -i ~/.ssh/cicd-dashboard-key ec2-user@[PUBLIC-IP]
   cd /opt/cicd-dashboard
   docker-compose restart backend
   ```

### Verify Integration

```bash
# Check backend health
curl http://[PUBLIC-IP]:5001/health

# Check Jenkins connection in backend logs
docker-compose logs backend | grep -i jenkins
```

## Monitoring and Logs

### Health Checks

```bash
# On public instance
curl http://[PUBLIC-IP]:5001/health

# Check Docker containers
docker-compose ps
```

### Logs

- **Application logs**: `docker-compose logs [service]`
- **System logs**: `/var/log/messages`
- **Docker logs**: `docker-compose logs`

## Backup and Recovery

### MongoDB Backup

```bash
# On private instance
ssh -i ~/.ssh/cicd-dashboard-key -J ec2-user@[PUBLIC-IP] ec2-user@[PRIVATE-IP]
cd /opt/cicd-dashboard
./backup.sh
```

Backups are automatically created daily at 2 AM.

## Security

### Security Groups

- **Public EC2**: HTTP/HTTPS, SSH from anywhere, Jenkins ports (8080, 50000)
- **Private EC2**: MongoDB and SSH from public EC2 only

### Network Security

- Private subnets have no direct internet access
- NAT Gateways for outbound internet access
- Database isolated in private subnet

## Scaling

### Horizontal Scaling

- Add more public EC2 instances
- Update load balancer configuration
- Distribute traffic across instances

### Vertical Scaling

- Change `instance_type` in terraform.tfvars
- Apply changes with `terraform apply`

## Troubleshooting

### Common Issues

1. **SSH Connection Failed**
   ```bash
   # Check security groups
   # Verify key permissions: chmod 600 ~/.ssh/cicd-dashboard-key
   ```

2. **Application Not Starting**
   ```bash
   # Check Docker containers
   docker-compose ps
   
   # Check logs
   docker-compose logs
   ```

3. **Database Connection Issues**
   ```bash
   # Verify MongoDB is running
   docker exec cicd-mongodb mongosh --eval "db.adminCommand('ping')"
   ```

4. **Jenkins Not Accessible**
   ```bash
   # Check if Jenkins container is running
   docker-compose ps jenkins
   
   # Check Jenkins logs
   docker-compose logs jenkins
   ```

5. **Frontend Not Loading Data**
   ```bash
   # Check backend API
   curl http://[PUBLIC-IP]:5001/api/pipelines
   
   # Check backend logs
   docker-compose logs backend
   ```

### Logs

- **Application logs**: `docker-compose logs [service]`
- **System logs**: `/var/log/messages`
- **Docker logs**: `docker-compose logs`

## Cleanup

### Destroy Infrastructure

```bash
# Make script executable
chmod +x destroy.sh

# Destroy the entire infrastructure
./destroy.sh
```

**Warning**: This will destroy all resources and data!

### Manual Cleanup

```bash
terraform destroy
```

## Cost Optimization

### Estimated Monthly Costs (us-west-2)

- **EC2 Instances** (1x t3.medium + 1x t2.micro): ~$35
- **EBS Storage**: ~$8
- **Data Transfer**: ~$5

**Total**: ~$48/month

### Cost Reduction Tips

1. Use `t3.small` for development
2. Use `t2.micro` for database (already configured)
3. Use spot instances for non-critical workloads
4. Implement auto-scaling based on demand

## Deployment Scripts Reference

### deploy-infra-only.sh
- Deploys only AWS infrastructure
- Generates SSH keys
- Runs Terraform init/plan/apply
- Outputs connection information

### copy-app-code.sh
- Copies application code to EC2 instances
- Sets up Docker containers
- Configures services
- Starts all applications

### jenkins-setup.sh
- Waits for Jenkins to be ready
- Displays initial admin password
- Provides setup instructions
- Helps with API token configuration

### destroy.sh
- Destroys all AWS resources
- Cleans up SSH keys
- Removes all data

## Support

For issues or questions:

1. Check the logs and health checks
2. Review security group configurations
3. Verify network connectivity
4. Check AWS service limits
5. Review the troubleshooting section above

## Security Considerations

- Change default passwords
- Use AWS Secrets Manager for sensitive data
- Enable VPC Flow Logs
- Regular security updates
- Monitor CloudTrail logs
- Keep Jenkins and application dependencies updated
